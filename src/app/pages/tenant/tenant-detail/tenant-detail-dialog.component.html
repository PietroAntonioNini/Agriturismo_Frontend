<div class="dialog-container">
  <!-- Loading spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Messaggio di errore -->
  <div *ngIf="errorMessage" class="error-message">
    <mat-icon>error</mat-icon>
    <span>{{ errorMessage }}</span>
  </div>

  <ng-container *ngIf="tenant && !isLoading">
    <div class="dialog-actions">
      <button mat-icon-button (click)="editTenant()" matTooltip="Modifica">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button color="warn" (click)="deleteTenant()" matTooltip="Elimina">
        <mat-icon>delete</mat-icon>
      </button>
      <button mat-icon-button (click)="close()" matTooltip="Chiudi">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    

    <mat-dialog-content class="dialog-content">
      <mat-card class="tenant-card">
        <mat-card-header>
          <div class="tenant-header">
            <div class="avatar-container mb-3">
              <div class="tenant-avatar">
                <mat-icon>person</mat-icon>
              </div>
            </div>
            <div class="tenant-title">
              <div class="tenant-subtitle">
                <span class="fs-4"
                  [matTooltip]="tooltipTexts['name']" 
                  #nameTooltip="matTooltip"
                  (click)="copyToClipboard(tenant.firstName + ' ' + tenant.lastName, 'name', nameTooltip)" 
                  style="cursor: pointer;">
                    {{ tenant.firstName }} {{ tenant.lastName }}
                </span>
              </div>
              <div *ngIf="tenant.address" class="tenant-subtitle"
                [matTooltip]="tooltipTexts['address']"
                #addressTooltip="matTooltip"
                (click)="copyToClipboard(tenant.address, 'address', addressTooltip)" 
                style="cursor: pointer;">
                  <mat-icon>home</mat-icon> 
                  <span>{{ tenant.address }}</span>
              </div>
              <div *ngIf="tenant.email" class="tenant-subtitle"
                [matTooltip]="tooltipTexts['email']" 
                #emailTooltip="matTooltip"
                (click)="copyToClipboard(tenant.email, 'email', emailTooltip)" 
                style="cursor: pointer;">
                  <mat-icon>email</mat-icon>
                  <span>{{ tenant.email }}</span>
              </div>
              <div class="tenant-subtitle mb-3" 
                [matTooltip]="tooltipTexts['phone']" 
                #phoneTooltip="matTooltip"
                (click)="copyToClipboard(tenant.phone, 'phone', phoneTooltip)" 
                style="cursor: pointer;">
                  <mat-icon>phone</mat-icon>
                  <span>{{ tenant.phone }}</span>
              </div>
            </div>
            <span matListItemLine>
              <mat-chip-set>
                <mat-chip *ngIf="tenant.communicationPreferences.email" class="chip-blue" selected><span class="text-white">Email</span></mat-chip>
                <mat-chip *ngIf="tenant.communicationPreferences.sms" class="chip-yellow" selected><span class="text-white">SMS</span></mat-chip>
                <mat-chip *ngIf="tenant.communicationPreferences.whatsapp" class="chip-green" selected><span class="text-white">WhatsApp</span></mat-chip>
              </mat-chip-set>
            </span>
          </div>
        </mat-card-header>

        <mat-card-content>
          <mat-tab-group animationDuration="300ms">
            <mat-tab>
              <ng-template mat-tab-label>
                <mat-icon class="me-1">description</mat-icon>
                <span>Documenti</span>
              </ng-template>
              <div class="tab-content">
                <mat-list *ngIf="tenant.notes" class="text-center">
                  <mat-list-item>
                    <h3 matListItemTitle>Note</h3>
                    <span matListItemLine>{{ tenant.notes || 'Nessuna nota' }}</span>
                  </mat-list-item>
                </mat-list>

                <!-- Nuova sezione documenti d'identità -->
                <div class="document-identity-section">
                  <div class="document-header">
                    <div class="document-title">
                      <div class="document-info">
                        <div class="info-pill">
                          <mat-icon>assignment_ind</mat-icon>
                          <span>{{ tenant.documentType || 'Carta d\'identità' }}</span>
                        </div>
                        <div class="info-pill" 
                          [matTooltip]="tooltipTexts['documentNumber']" 
                          #documentNumberTooltip="matTooltip"
                          (click)="copyToClipboard(tenant.documentNumber, 'documentNumber', documentNumberTooltip)" 
                          style="cursor: pointer;">
                          <mat-icon>confirmation_number</mat-icon>
                          <span class="text-uppercase">{{ tenant.documentNumber || 'CA70837EO' }}</span>
                        </div>
                        <div class="info-pill">
                          <mat-icon>event</mat-icon>
                          <span>Scadenza: {{ formatDate(tenant.documentExpiryDate) || '22/03/2025' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="document-cards-container">
                    <!-- Fronte documento -->
                    <div class="document-card" [class.has-image]="tenant.documentFrontImage">
                      <div class="card-header">
                        <h3>Fronte</h3>
                        <div class="card-actions" *ngIf="tenant.documentFrontImage">
                          <button mat-icon-button matTooltip="Scarica" (click)="downloadDocument('front', 'fronte-documento')">
                            <mat-icon>download</mat-icon>
                          </button>
                          <button mat-icon-button matTooltip="Sostituisci" (click)="replaceFrontImage()">
                            <mat-icon>autorenew</mat-icon>
                          </button>
                          <button mat-icon-button matTooltip="Elimina" color="warn" (click)="removeFrontImage()">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>
                      </div>
                      
                      <div class="card-content">
                        <!-- Visualizzazione con immagine -->
                        <div class="card-image-container" *ngIf="tenant.documentFrontImage">
                          <img [src]="getImageUrl(tenant.documentFrontImage)" alt="Fronte documento" (click)="openImagePreview(tenant.documentFrontImage)">
                        </div>
                        
                        <!-- Visualizzazione senza immagine (placeholder) -->
                        <div class="empty-document" *ngIf="!tenant.documentFrontImage">
                          <div class="empty-document-icon">
                            <mat-icon>image_not_supported</mat-icon>
                          </div>
                          <p>Nessuna immagine fronte caricata</p>
                          <button mat-stroked-button color="primary" (click)="uploadFrontImage()">
                            <mat-icon>add_photo_alternate</mat-icon>
                            <span>Carica fronte</span>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Retro documento -->
                    <div class="document-card" [class.has-image]="tenant.documentBackImage">
                      <div class="card-header">
                        <h3>Retro</h3>
                        <div class="card-actions" *ngIf="tenant.documentBackImage">
                          <button mat-icon-button matTooltip="Scarica" (click)="downloadDocument('back', 'retro-documento')">
                            <mat-icon>download</mat-icon>
                          </button>
                          <button mat-icon-button matTooltip="Sostituisci" (click)="replaceBackImage()">
                            <mat-icon>autorenew</mat-icon>
                          </button>
                          <button mat-icon-button matTooltip="Elimina" color="warn" (click)="removeBackImage()">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>
                      </div>
                      
                      <div class="card-content">
                        <!-- Visualizzazione con immagine -->
                        <div class="card-image-container" *ngIf="tenant.documentBackImage">
                          <img [src]="getImageUrl(tenant.documentBackImage)" alt="Retro documento" (click)="openImagePreview(tenant.documentBackImage)">
                        </div>
                        
                        <!-- Visualizzazione senza immagine (placeholder) -->
                        <div class="empty-document" *ngIf="!tenant.documentBackImage">
                          <div class="empty-document-icon">
                            <mat-icon>image_not_supported</mat-icon>
                          </div>
                          <p>Nessuna immagine retro caricata</p>
                          <button mat-stroked-button color="primary" (click)="uploadBackImage()">
                            <mat-icon>add_photo_alternate</mat-icon>
                            <span>Carica retro</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </mat-tab>
            
            <mat-tab>
              <ng-template mat-tab-label>
                <mat-icon class="me-1">assignment</mat-icon>
                <span>Contratti Attivi</span>
              </ng-template>
              <div class="tab-content">
                <div *ngIf="activeLeases.length === 0 && !errorMessage" class="no-data-message">
                  <mat-icon>info</mat-icon>
                  <span>Nessun contratto attivo per questo inquilino</span>
                </div>
                
                <div *ngIf="errorMessage" class="error-message">
                  <mat-icon>error</mat-icon>
                  <span>{{ errorMessage }}</span>
                </div>
                
                <!-- Card contratti -->
                <div *ngFor="let lease of activeLeases" class="contract-card">
                  <div class="contract-header">
                    <div class="contract-status active">
                      <span class="status-dot"></span>
                      <span class="status-text">Attivo</span>
                    </div>
                    <div class="contract-id">
                      <h3>Contratto #{{ lease.id }}</h3>
                      <span class="property-tag">Appartamento ID: {{ lease.apartmentId }}</span>
                    </div>
                    <div class="contract-actions">
                      <button class="action-button edit" matTooltip="Modifica">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button class="action-button more" matTooltip="Opzioni">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                    </div>
                  </div>
                
                  <div class="contract-body">
                    <div class="contract-info-redesigned">
                      <div class="contract-dates">
                        <div class="date-item">
                          <div class="date-label">
                            <mat-icon>calendar_today</mat-icon>
                            Inizio
                          </div>
                          <div class="date-value">{{ formatDate(lease.startDate) }}</div>
                        </div>
                          <div class="contract-timeline">
                            <div class="timeline-progress">
                              <span class="m-auto">{{ getRemainingMonths(lease.endDate) }} mesi rimanenti</span>
                              <div class="progress-bar">
                                <div class="progress-fill" [style.width]="getContractProgress(lease.startDate, lease.endDate)"></div>
                              </div>
                            </div>
                          </div>
                        <div class="date-item">
                          <div class="date-label">
                            <mat-icon>event</mat-icon>
                            Fine
                          </div>
                          <div class="date-value">{{ formatDate(lease.endDate) }}</div>
                        </div>
                      </div>
                      
                      <div class="contract-details">
                        <div class="detail-item">
                          <div class="detail-badge">
                            <mat-icon>payments</mat-icon>
                            Canone
                          </div>
                          <div class="detail-value">€{{ lease.monthlyRent }}<span class="detail-period">/mese</span></div>
                        </div>
                        <div class="payment-status-badge paid">Pagato</div>
                      </div>
                    </div>
                  </div>

                  <div class="contract-footer">
                    <button class="view-details" [routerLink]="['/lease/detail', lease.id]" (click)="close()">
                      <mat-icon>visibility</mat-icon>
                      <span>Visualizza Dettagli</span>
                    </button>
                    <div class="d-flex gap-2">
                      <button class="quick-action" matTooltip="Rinnova contratto">
                        <mat-icon>autorenew</mat-icon>
                      </button>
                      <button class="quick-action" matTooltip="Documenti">
                        <mat-icon>description</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </mat-tab>
          </mat-tab-group>
        </mat-card-content>
      </mat-card>
    </mat-dialog-content>
  </ng-container>
</div>