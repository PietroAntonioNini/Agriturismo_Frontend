<div class="invoice-page">

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-overlay">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <p class="loading-text">Caricamento fatture in corso...</p>
  </div>

  <!-- Page Content -->
  <div class="page-content" [class.hidden]="isLoading">

    <!-- ═══ Header ═══ -->
    <div class="page-header">
      <div class="header-left">
        <h1 class="page-title">Gestione Fatture</h1>
        <p class="page-subtitle">Visualizza e gestisci tutte le fatture per appartamento</p>
      </div>
      <div class="header-actions">
        <button class="btn-primary-header" (click)="openCreateInvoiceDialog()">
          <mat-icon>add_circle</mat-icon>
          Crea Fattura
        </button>
        <button class="btn-primary-header" (click)="openMonthlyStatementDialog()">
          <mat-icon>add</mat-icon>
          Prospetto Mensile
        </button>
      </div>
    </div>

    <!-- ═══ Stats Grid (4 cards) ═══ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-top">
          <span class="stat-label">Totale Fatture</span>
          <div class="stat-icon-box blue">
            <mat-icon>receipt_long</mat-icon>
          </div>
        </div>
        <p class="stat-value">{{dataSource.data.length}}</p>
        <p class="stat-sub">fatture registrate</p>
      </div>

      <div class="stat-card">
        <div class="stat-top">
          <span class="stat-label">Valore Totale</span>
          <div class="stat-icon-box purple">
            <mat-icon>trending_up</mat-icon>
          </div>
        </div>
        <p class="stat-value">{{(kpi$ | async)?.totalInvoiced | currency:'EUR':'symbol':'1.2-2'}}</p>
        <p class="stat-sub">Tutte le fatture</p>
      </div>

      <div class="stat-card">
        <div class="stat-top">
          <span class="stat-label">Incassato</span>
          <div class="stat-icon-box emerald">
            <mat-icon>check_circle</mat-icon>
          </div>
        </div>
        <p class="stat-value color-emerald">{{(kpi$ | async)?.totalPaid | currency:'EUR':'symbol':'1.2-2'}}</p>
        <p class="stat-sub">del totale incassato</p>
      </div>

      <div class="stat-card">
        <div class="stat-top">
          <span class="stat-label">Da Incassare</span>
          <div class="stat-icon-box amber">
            <mat-icon>error_outline</mat-icon>
          </div>
        </div>
        <p class="stat-value color-amber">{{(kpi$ | async)?.totalUnpaid | currency:'EUR':'symbol':'1.2-2'}}</p>
        <p class="stat-sub">{{(kpi$ | async)?.overdueInvoices}} fatture non pagate</p>
      </div>
    </div>

    <!-- ═══ Search & Filter Bar ═══ -->
    <div class="search-bar" #advancedFiltersWrapper>
      <div class="search-input-wrap">
        <mat-icon class="search-icon-el">search</mat-icon>
        <input type="text"
          class="search-input"
          placeholder="Cerca per appartamento o inquilino..."
          [formControl]="searchControl">
        <button *ngIf="searchControl.value" class="clear-search-btn" (click)="searchControl.setValue('')">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="filter-pills">
        <button class="pill"
          [class.active]="statusFilterControl.value === 'all'"
          (click)="statusFilterControl.setValue('all')">
          Tutte
        </button>
        <button class="pill pill-success"
          [class.active]="statusFilterControl.value === 'paid'"
          (click)="statusFilterControl.setValue('paid')">
          Pagate
        </button>
        <button class="pill pill-warning"
          [class.active]="statusFilterControl.value === 'unpaid'"
          (click)="statusFilterControl.setValue('unpaid')">
          Non Pagate
        </button>
        <button class="pill pill-danger"
          [class.active]="statusFilterControl.value === 'overdue'"
          (click)="statusFilterControl.setValue('overdue')">
          Scadute
        </button>
      </div>

      <div class="bar-actions">
        <button class="btn-bar"
          [class.active]="isAdvancedFiltersOpen || hasActiveAdvancedFilters()"
          (click)="toggleAdvancedFilters($event)">
          <mat-icon>filter_alt</mat-icon>
          Filtri
        </button>
        <button class="btn-bar" (click)="openMonthlyStatementDialog()">
          <mat-icon>download</mat-icon>
          Esporta
        </button>
      </div>

      <!-- Advanced Filters Panel -->
      <div class="adv-filters-panel" *ngIf="isAdvancedFiltersOpen">
        <div class="adv-filters-head">
          <h4>Filtri avanzati</h4>
          <button class="reset-link" (click)="resetFilters()">
            <mat-icon>close</mat-icon>
            Reset
          </button>
        </div>

        <div class="adv-filters-grid">
          <mat-form-field appearance="outline" class="adv-field">
            <mat-label>Periodo</mat-label>
            <mat-select #periodSelectRef [formControl]="periodFilterControl"
              (openedChange)="onAdvancedSelectOpened($event, 'period')">
              <mat-option value="all">Tutti i periodi</mat-option>
              <mat-option value="this_month">Questo mese</mat-option>
              <mat-option value="last_month">Mese scorso</mat-option>
              <mat-option value="this_year">Questo anno</mat-option>
              <mat-option value="custom">Periodo personalizzato</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="adv-field">
            <mat-label>Appartamento</mat-label>
            <mat-select #apartmentSelectRef [formControl]="apartmentFilterControl"
              (openedChange)="onAdvancedSelectOpened($event, 'apartment')">
              <mat-option value="all">Tutti gli appartamenti</mat-option>
              <mat-option *ngFor="let apt of allApartments" [value]="apt.id">{{apt.name}}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="adv-field">
            <mat-label>Inquilino</mat-label>
            <mat-select #tenantSelectRef [formControl]="tenantFilterControl"
              (openedChange)="onAdvancedSelectOpened($event, 'tenant')">
              <mat-option value="all">Tutti gli inquilini</mat-option>
              <mat-option *ngFor="let tenant of allTenants" [value]="tenant.id">{{tenant.name}}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="adv-field">
            <mat-label>Tipo Voce</mat-label>
            <mat-select #typeSelectRef [formControl]="typeFilterControl"
              (openedChange)="onAdvancedSelectOpened($event, 'type')">
              <mat-option *ngFor="let type of invoiceTypes" [value]="type.value">{{type.label}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </div>

    <!-- ═══ Bulk Actions ═══ -->
    <div class="bulk-bar" *ngIf="selectedInvoices.size > 0">
      <div class="bulk-info">
        <mat-icon>check_circle</mat-icon>
        <span>{{selectedInvoices.size}} fattura/e selezionata/e</span>
      </div>
      <div class="bulk-btns">
        <button class="btn-bar" (click)="markSelectedAsPaid()" [disabled]="isLoading">
          <mat-icon>payments</mat-icon>
          Marca come Pagate
        </button>
        <button class="btn-bar" (click)="sendRemindersToSelected()" [disabled]="isLoading">
          <mat-icon>notifications</mat-icon>
          Invia Promemoria
        </button>
      </div>
    </div>

    <!-- ═══ No Results ═══ -->
    <div *ngIf="!isLoading && dataSource.filteredData.length === 0 && searchControl.value" class="no-results">
      <mat-icon>search_off</mat-icon>
      <h3>Nessun risultato</h3>
      <p>Nessun appartamento trovato con i criteri di ricerca</p>
    </div>

    <!-- ═══ Apartment Accordion List ═══ -->
    <div class="apartments-list" *ngIf="!isLoading && dataSource.filteredData.length > 0">
      <div *ngFor="let group of getGroupedInvoices(); trackBy: trackByApartmentId; let first = first"
        class="apt-accordion"
        [class.open]="isApartmentOpen(group.apartmentId)">

        <!-- Accordion Header -->
        <button class="apt-header" (click)="toggleApartmentAccordion(group.apartmentId)">
          <div class="apt-header-top">
            <div class="apt-info">
              <div class="apt-icon-box">
                <mat-icon>apartment</mat-icon>
              </div>
              <div class="apt-text">
                <h3 class="apt-name">{{group.name}}</h3>
                <p class="apt-tenant">{{group.tenant}}</p>
              </div>
            </div>
            <div class="apt-header-right">
              <span class="apt-badge">{{group.invoices.length}} fatture</span>
              <mat-icon class="chevron-icon">expand_more</mat-icon>
            </div>
          </div>

          <!-- Mini Stats inside header -->
          <div class="apt-mini-stats">
            <div class="mini-stat">
              <div class="mini-stat-head">
                <mat-icon class="mini-icon gray">trending_up</mat-icon>
                <span class="mini-label">Totale</span>
              </div>
              <p class="mini-value">{{getApartmentTotal(group.invoices) | currency:'EUR':'symbol':'1.2-2'}}</p>
            </div>

            <div class="mini-stat">
              <div class="mini-stat-head">
                <mat-icon class="mini-icon emerald">check_circle</mat-icon>
                <span class="mini-label">Pagate ({{getApartmentPaidCount(group.invoices)}})</span>
              </div>
              <p class="mini-value color-emerald">{{getApartmentPaidAmount(group.invoices) | currency:'EUR':'symbol':'1.2-2'}}</p>
            </div>

            <div class="mini-stat">
              <div class="mini-stat-head">
                <mat-icon class="mini-icon amber">error_outline</mat-icon>
                <span class="mini-label">Non Pagate ({{getApartmentUnpaidCount(group.invoices)}})</span>
              </div>
              <p class="mini-value color-amber">{{getApartmentUnpaidAmount(group.invoices) | currency:'EUR':'symbol':'1.2-2'}}</p>
            </div>

            <div class="mini-stat">
              <div class="mini-stat-head">
                <mat-icon class="mini-icon gray">event</mat-icon>
                <span class="mini-label">Prossima Scadenza</span>
              </div>
              <p class="mini-value small">{{getNextDueDate(group.invoices) || 'Nessuna'}}</p>
            </div>
          </div>
        </button>

        <!-- Accordion Body (animated via CSS grid-template-rows) -->
        <div class="apt-body">
          <div class="apt-body-inner">
            <div class="apt-body-content">
              <div class="timeline-indicator">
                <mat-icon>event</mat-icon>
                <span class="timeline-label">Cronologia Fatture</span>
                <span class="timeline-sub">&bull; Ordine: più recenti prima</span>
              </div>

              <div class="inv-grid">
                <div *ngFor="let invoice of group.invoices; trackBy: trackByInvoiceId"
                  class="inv-card" [class]="getStatusClass(invoice)">

                  <!-- Invoice Header -->
                  <div class="inv-header">
                    <div class="inv-header-left">
                      <h4 class="inv-number">{{invoice.invoiceNumber}}</h4>
                      <div class="inv-period">
                        <mat-icon>event</mat-icon>
                        <span>{{getPeriodLabel(invoice)}}</span>
                      </div>
                    </div>
                    <span class="inv-status-badge" [class]="getStatusClass(invoice)">
                      {{getStatusLabel(invoice)}}
                    </span>
                  </div>

                  <!-- Invoice Info Row -->
                  <div class="inv-info-row">
                    <div class="inv-info-item">
                      <mat-icon class="info-icon">person</mat-icon>
                      <span>{{getTenantName(invoice.tenantId)}}</span>
                    </div>
                    <div class="inv-info-item">
                      <mat-icon class="info-icon">apartment</mat-icon>
                      <span>{{getApartmentName(invoice.apartmentId)}}</span>
                    </div>
                  </div>

                  <!-- Invoice Center (total + dates) -->
                  <div class="inv-center">
                    <div class="inv-total-block">
                      <p class="inv-total-label">Totale Fattura</p>
                      <p class="inv-total-value">{{formatCurrency(invoice.total)}}</p>
                    </div>
                    <div class="inv-dates-block">
                      <div class="inv-date-row">
                        <span class="date-lbl">Emissione:</span>
                        <span class="date-val emerald">{{formatDate(invoice.issueDate)}}</span>
                      </div>
                      <div class="inv-date-row">
                        <span class="date-lbl">Scadenza:</span>
                        <span class="date-val amber">{{formatDate(invoice.dueDate)}}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Items Toggle -->
                  <button class="inv-items-toggle" (click)="toggleInvoiceItems(invoice.id, $event)">
                    <span class="toggle-label">Voci ({{invoice.items.length}})</span>
                    <mat-icon class="toggle-chevron" [class.rotated]="isInvoiceItemsOpen(invoice.id)">expand_more</mat-icon>
                  </button>

                  <!-- Expandable Items -->
                  <div class="inv-items-body" [class.open]="isInvoiceItemsOpen(invoice.id)">
                    <div class="inv-items-inner">
                      <div class="inv-items-grid">
                        <div *ngFor="let item of invoice.items; trackBy: trackByItemIndex" class="inv-item-row">
                          <span class="inv-item-name">
                            <mat-icon [style.color]="getItemTypeColor(item.type)">{{getItemTypeIcon(item.type)}}</mat-icon>
                            {{getItemTypeLabel(item.type)}}
                          </span>
                          <span class="inv-item-amount">{{formatCurrency(item.amount)}}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Invoice Footer Actions -->
                  <div class="inv-footer">
                    <button type="button" class="action-btn view" matTooltip="Visualizza" (click)="viewInvoice(invoice.id); $event.stopPropagation()">
                      <mat-icon>visibility</mat-icon>
                    </button>
                    <button type="button" class="action-btn edit" matTooltip="Modifica" (click)="editInvoice(invoice.id); $event.stopPropagation()">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button type="button" class="action-btn print" matTooltip="Stampa" (click)="printInvoice(invoice.id); $event.stopPropagation()">
                      <mat-icon>print</mat-icon>
                    </button>
                    <button type="button" class="action-btn delete" matTooltip="Elimina" (click)="deleteInvoice(invoice.id); $event.stopPropagation()">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ Footer ═══ -->
    <div class="page-footer" *ngIf="!isLoading && dataSource.filteredData.length > 0">
      Visualizzazione {{getGroupedInvoices().length}} appartamenti &bull; {{dataSource.filteredData.length}} fatture totali
    </div>

  </div>
</div>
