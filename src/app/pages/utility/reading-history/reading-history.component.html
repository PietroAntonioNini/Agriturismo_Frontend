<div class="reading-history-container" (click)="closeAdvancedFilters()">
  
  <!-- Header compatto -->
  <div class="history-header">
    <div class="header-left">
      <mat-icon class="title-icon">analytics</mat-icon>
      <h1>Storico Letture</h1>
      <span class="header-count" *ngIf="!isLoading && dataSource.data.length > 0">
        {{dataSource.data.length}}
      </span>
    </div>
    
    <div class="header-actions">
      <button mat-stroked-button [matMenuTriggerFor]="viewMenu" class="view-toggle-btn">
        <mat-icon>{{viewMode === 'table' ? 'table_view' : 'dashboard'}}</mat-icon>
        <span class="btn-label">{{viewMode === 'table' ? 'Tabella' : 'Raggruppata'}}</span>
        <mat-icon class="arrow-icon">expand_more</mat-icon>
      </button>
      
      <button mat-stroked-button (click)="exportData()" 
              [disabled]="dataSource.data.length === 0" 
              matTooltip="Esporta dati" class="export-btn">
        <mat-icon>file_download</mat-icon>
        <span class="btn-label">Esporta</span>
      </button>
      
      <button mat-icon-button (click)="onClose()" matTooltip="Chiudi" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <!-- Menu Vista -->
  <mat-menu #viewMenu="matMenu" class="view-menu">
    <button mat-menu-item (click)="setViewMode('table')" [class.active]="viewMode === 'table'">
      <mat-icon>table_view</mat-icon>
      <span>Vista Tabella</span>
      <mat-icon *ngIf="viewMode === 'table'" class="check-icon">check</mat-icon>
    </button>
    <button mat-menu-item (click)="setViewMode('grouped')" [class.active]="viewMode === 'grouped'">
      <mat-icon>dashboard</mat-icon>
      <span>Vista Raggruppata</span>
      <mat-icon *ngIf="viewMode === 'grouped'" class="check-icon">check</mat-icon>
    </button>
  </mat-menu>

  <!-- Barra Filtri compatta -->
  <div class="filters-bar" [formGroup]="filterForm">
    
    <!-- Ricerca inline -->
    <div class="search-input-wrapper">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="text" class="search-input" placeholder="Cerca..." formControlName="search">
      <button *ngIf="filterForm.get('search')?.value" class="search-clear" 
              (click)="filterForm.patchValue({search: ''})">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Chip di stato pagamento -->
    <div class="status-chips">
      <button class="status-chip" 
              [class.active]="filterForm.get('isPaid')?.value === ''"
              (click)="setPaymentFilter('')">
        Tutte
      </button>
      <button class="status-chip chip-paid" 
              [class.active]="filterForm.get('isPaid')?.value === true"
              (click)="setPaymentFilter(true)">
        <mat-icon>check_circle</mat-icon>
        Pagate
      </button>
      <button class="status-chip chip-unpaid" 
              [class.active]="filterForm.get('isPaid')?.value === false"
              (click)="setPaymentFilter(false)">
        <mat-icon>schedule</mat-icon>
        Non Pagate
      </button>
    </div>

    <!-- Pulsante filtri avanzati -->
    <div class="filters-trigger-wrapper" (click)="$event.stopPropagation()">
      <button class="filters-trigger" 
              [class.active]="isAdvancedFiltersOpen || hasActiveAdvancedFilters()"
              (click)="toggleAdvancedFilters($event)">
        <mat-icon>filter_alt</mat-icon>
        <span>Filtri</span>
        <span class="filter-badge" *ngIf="getAdvancedFiltersCount() > 0">
          {{getAdvancedFiltersCount()}}
        </span>
      </button>

      <!-- Popover filtri avanzati -->
      <div class="advanced-filters-panel" *ngIf="isAdvancedFiltersOpen">
        <div class="panel-header">
          <span class="panel-title">Filtri Avanzati</span>
          <button *ngIf="hasActiveAdvancedFilters()" class="panel-reset" (click)="clearAdvancedFilters()">
            <mat-icon>restart_alt</mat-icon>
            Reset
          </button>
        </div>
        <div class="advanced-filters-grid">
          <mat-form-field appearance="outline">
            <mat-label>Appartamento</mat-label>
            <mat-select formControlName="apartmentId">
              <mat-option [value]="">Tutti</mat-option>
              <mat-option *ngFor="let apartment of data.apartments" [value]="apartment.id">
                {{apartment.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Tipo Utenza</mat-label>
            <mat-select formControlName="utilityType">
              <mat-option [value]="">Tutte</mat-option>
              <mat-option *ngFor="let type of utilityTypes" [value]="type.type">
                <div class="utility-option">
                  <mat-icon [style.color]="type.color">{{type.icon}}</mat-icon>
                  <span>{{type.label}}</span>
                </div>
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Data inizio</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="startDate">
            <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Data fine</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="endDate">
            <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>
        </div>
      </div>
    </div>

    <!-- Pulsante pulisci (visibile solo con filtri attivi) -->
    <button *ngIf="getActiveFiltersCount() > 0" class="clear-all-btn" (click)="clearFilters()" matTooltip="Pulisci tutti i filtri">
      <mat-icon>clear_all</mat-icon>
    </button>
  </div>

  <!-- Stati dell'applicazione -->
  
  <!-- Loading State -->
  <div *ngIf="isLoading" class="state-container loading-state">
    <div class="state-content">
      <mat-spinner diameter="48"></mat-spinner>
      <h3>Caricamento in corso</h3>
      <p>Recupero delle letture utility dal server...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading" class="state-container error-state">
    <div class="state-content">
      <mat-icon class="state-icon error-icon">error_outline</mat-icon>
      <h3>Errore di caricamento</h3>
      <p>{{errorMessage}}</p>
      <button mat-raised-button color="primary" (click)="loadReadings()" class="retry-btn">
        <mat-icon>refresh</mat-icon>
        Riprova
      </button>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && !errorMessage && dataSource.data.length === 0" class="state-container empty-state">
    <div class="state-content">
      <mat-icon class="state-icon empty-icon">inbox</mat-icon>
      <h3>Nessuna lettura trovata</h3>
      <p *ngIf="getActiveFiltersCount() > 0">Prova a modificare i filtri di ricerca per trovare più risultati.</p>
      <p *ngIf="getActiveFiltersCount() === 0">Non sono ancora state inserite letture nel sistema.</p>
      <div class="empty-actions">
        <button *ngIf="getActiveFiltersCount() > 0" mat-raised-button color="primary" (click)="clearFilters()">
          <mat-icon>clear_all</mat-icon>
          Rimuovi Filtri
        </button>
        <button mat-stroked-button (click)="onClose()">
          <mat-icon>close</mat-icon>
          Chiudi
        </button>
      </div>
    </div>
  </div>

  <!-- Vista Tabella ottimizzata per 5 elementi -->
  <div *ngIf="!isLoading && !errorMessage && dataSource.data.length > 0 && viewMode === 'table'" 
       class="content-section table-section">
    
    <mat-card class="table-card" elevation="1">
      <mat-card-header class="table-header">
        <mat-card-title>
          <mat-icon>table_view</mat-icon>
          Dettaglio Letture
        </mat-card-title>
        <!-- Rimossa la sezione table-actions con page size selector -->
      </mat-card-header>
      
      <mat-card-content class="table-content">
        <div class="table-wrapper">
          <table mat-table [dataSource]="dataSource" matSort class="modern-table">
            
            <!-- Apartment Column -->
            <ng-container matColumnDef="apartmentName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="apartment-header">
                <div class="header-content">
                  <mat-icon>apartment</mat-icon>
                  <span>Appartamento</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let reading" class="apartment-cell">
                <div class="cell-content">
                  <mat-icon class="cell-icon">home</mat-icon>
                  <span class="cell-text">{{reading.apartmentName}}</span>
                </div>
              </td>
            </ng-container>

            <!-- Utility Type Column -->
            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="utility-header">
                <div class="header-content">
                  <mat-icon>category</mat-icon>
                  <span>Utenza</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let reading" class="utility-cell">
                <div class="utility-badge" [style.background-color]="getUtilityTypeConfig(reading.type).color + '20'">
                  <mat-icon [style.color]="getUtilityTypeConfig(reading.type).color" class="utility-icon">
                    {{getUtilityTypeConfig(reading.type).icon}}
                  </mat-icon>
                  <span class="utility-label">{{getUtilityTypeConfig(reading.type).label}}</span>
                  <!-- ⭐ Badge per lettura lavanderia -->
                  <mat-icon *ngIf="reading.subtype === 'laundry'" 
                            class="subtype-badge" 
                            style="color: #FFA726; font-size: 18px; margin-left: 4px"
                            matTooltip="Lavanderia Comune">
                    local_laundry_service
                  </mat-icon>
                  <!-- ⭐ Fallback per isSpecialReading -->
                  <mat-icon *ngIf="reading.isSpecialReading && reading.subtype !== 'laundry'" 
                            class="subtype-badge" 
                            style="color: #FFA726; font-size: 18px; margin-left: 4px"
                            matTooltip="Lettura Speciale">
                    star
                  </mat-icon>
                </div>
              </td>
            </ng-container>

            <!-- Reading Date Column -->
            <ng-container matColumnDef="readingDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="date-header">
                <div class="header-content">
                  <mat-icon>event</mat-icon>
                  <span>Data Lettura</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let reading" class="date-cell">
                <div class="date-content">
                  <span class="date-value">{{formatDate(reading.readingDate)}}</span>
                </div>
              </td>
            </ng-container>

            <!-- Current Reading Column -->
            <ng-container matColumnDef="currentReading">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="reading-header">
                <div class="header-content">
                  <mat-icon>speed</mat-icon>
                  <span>Lettura</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let reading" class="reading-cell">
                <div class="reading-content">
                  <span class="reading-value">{{reading.currentReading | number:'1.0-3'}}</span>
                  <span class="reading-unit">{{getUtilityTypeConfig(reading.type).unit}}</span>
                </div>
              </td>
            </ng-container>

            <!-- Consumption Column -->
            <ng-container matColumnDef="consumption">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="consumption-header">
                <div class="header-content">
                  <mat-icon>trending_up</mat-icon>
                  <span>Consumo</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let reading" class="consumption-cell">
                <div class="consumption-content">
                  <span class="consumption-value" 
                        [class.high-consumption]="reading.consumption > 200">
                    {{reading.consumption | number:'1.0-3'}}
                  </span>
                  <span class="consumption-unit">{{getUtilityTypeConfig(reading.type).unit}}</span>
                </div>
              </td>
            </ng-container>

            <!-- Total Cost Column -->
            <ng-container matColumnDef="totalCost">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="cost-header">
                <div class="header-content">
                  <mat-icon>euro</mat-icon>
                  <span>Costo</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let reading" class="cost-cell">
                <div class="cost-content">
                  <span class="cost-value">{{formatCurrency(reading.totalCost)}}</span>
                </div>
              </td>
            </ng-container>

            <!-- Payment Status Column -->
            <ng-container matColumnDef="isPaid">
              <th mat-header-cell *matHeaderCellDef class="payment-header">
                <div class="header-content">
                  <mat-icon>payments</mat-icon>
                  <span>Pagamento</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let reading" class="payment-cell">
                <mat-chip-option class="payment-chip" 
                               [class.paid]="reading.isPaid" 
                               [class.unpaid]="!reading.isPaid"
                               (click)="togglePaymentStatus(reading)">
                  <mat-icon>{{reading.isPaid ? 'check_circle' : 'schedule'}}</mat-icon>
                  <span>{{reading.isPaid ? 'Pagato' : 'In Attesa'}}</span>
                </mat-chip-option>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="actions-header">
                <span>Azioni</span>
              </th>
              <td mat-cell *matCellDef="let reading" class="actions-cell">
                <div class="actions-content">
                  <button mat-icon-button (click)="editReading(reading)" 
                          matTooltip="Modifica lettura" class="edit-btn">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button (click)="deleteReading(reading)" 
                          matTooltip="Elimina lettura" class="delete-btn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
          </table>
        </div>
        
        <!-- Paginator con solo navigazione (massimo 5 elementi per pagina) -->
        <mat-paginator #paginator
                       [pageSize]="5"
                       [hidePageSize]="true"
                       showFirstLastButtons
                       class="custom-paginator">
        </mat-paginator>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Vista Raggruppata -->
  <div *ngIf="!isLoading && !errorMessage && dataSource.data.length > 0 && viewMode === 'grouped'" 
       class="content-section grouped-section">
    
    <div class="grouped-header">
      <h3>
        <mat-icon>dashboard</mat-icon>
        Vista per Appartamento
      </h3>
      <p>{{groupedData.length}} {{groupedData.length === 1 ? 'appartamento' : 'appartamenti'}} con letture</p>
    </div>
    
    <div class="apartments-grid">
      <div *ngFor="let group of groupedData" class="flip-card-container">
        <div class="flip-card" [class.flipped]="isCardFlipped(group.apartmentId)">
          
          <!-- FRONTE DELLA CARD -->
          <div class="flip-card-front">
            <mat-card class="apartment-card" elevation="2">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>apartment</mat-icon>
                  {{group.apartment}}
                </mat-card-title>
                <mat-card-subtitle>
                  {{group.readings.length}} {{group.readings.length === 1 ? 'lettura' : 'letture'}}
                </mat-card-subtitle>
              </mat-card-header>
              
              <mat-card-content>
                <!-- Riassunto consumi -->
                <div class="consumption-summary">
                  <div class="summary-item" *ngIf="group.totals.electricity.consumption > 0">
                    <mat-icon style="color: #ffc107">bolt</mat-icon>
                    <div class="summary-details">
                      <span class="summary-label">Elettricità</span>
                      <span class="summary-value">{{group.totals.electricity.consumption | number:'1.0-3'}} kWh</span>
                      <span class="summary-cost">{{formatCurrency(group.totals.electricity.cost)}}</span>
                    </div>
                  </div>
                  
                  <div class="summary-item" *ngIf="group.totals.water.consumption > 0">
                    <mat-icon style="color: #2196F3">water_drop</mat-icon>
                    <div class="summary-details">
                      <span class="summary-label">Acqua</span>
                      <span class="summary-value">{{group.totals.water.consumption | number:'1.0-3'}} m³</span>
                      <span class="summary-cost">{{formatCurrency(group.totals.water.cost)}}</span>
                    </div>
                  </div>
                  
                  <div class="summary-item" *ngIf="group.totals.gas.consumption > 0">
                    <mat-icon style="color: #FF5722">local_fire_department</mat-icon>
                    <div class="summary-details">
                      <span class="summary-label">Gas</span>
                      <span class="summary-value">{{group.totals.gas.consumption | number:'1.0-3'}} m³</span>
                      <span class="summary-cost">{{formatCurrency(group.totals.gas.cost)}}</span>
                    </div>
                  </div>
                  
                  <div class="total-cost">
                    <strong>Totale: {{formatCurrency(group.totals.total)}}</strong>
                  </div>
                </div>
              </mat-card-content>
              
              <!-- Pulsante flip -->
              <mat-card-actions>
                <button mat-fab color="primary" class="flip-button" 
                        (click)="toggleCardFlip(group.apartmentId)"
                        matTooltip="Vedi dettagli">
                  <mat-icon>info</mat-icon>
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
          
          <!-- RETRO DELLA CARD -->
          <div class="flip-card-back">
            <mat-card class="apartment-card" elevation="2">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>apartment</mat-icon>
                  {{group.apartment}} - Dettagli
                </mat-card-title>
              </mat-card-header>
              
              <mat-card-content>
                <!-- Lista letture recenti -->
                <div class="recent-readings">
                  <h4>Ultime Letture</h4>
                  <div class="readings-list">
                    <div *ngFor="let reading of group.readings.slice(0, 3)" class="reading-item">
                      <div class="reading-info">
                        <mat-icon [style.color]="getUtilityTypeConfig(reading.type).color">
                          {{getUtilityTypeConfig(reading.type).icon}}
                        </mat-icon>
                        <!-- ⭐ Badge lavanderia anche nella vista raggruppata -->
                        <mat-icon *ngIf="reading.subtype === 'laundry'" 
                                  style="color: #FFA726; font-size: 16px; margin-left: 4px"
                                  matTooltip="Lavanderia Comune">
                          local_laundry_service
                        </mat-icon>
                        <span class="reading-date">{{formatDate(reading.readingDate)}}</span>
                        <span class="reading-consumption">{{reading.consumption | number:'1.0-3'}} {{getUtilityTypeConfig(reading.type).unit}}</span>
                      </div>
                      <mat-chip-option class="reading-status" 
                                     [class.paid]="reading.isPaid" 
                                     [class.unpaid]="!reading.isPaid">
                        {{reading.isPaid ? 'Pagato' : 'In Attesa'}}
                      </mat-chip-option>
                    </div>
                  </div>
                  
                  <button *ngIf="group.readings.length > 3" mat-button color="primary" 
                          (click)="setViewMode('table'); filterForm.patchValue({apartmentId: group.apartmentId})">
                    Vedi tutte le {{group.readings.length}} letture
                  </button>
                </div>
              </mat-card-content>
              
              <!-- Pulsante ritorna -->
              <mat-card-actions>
                <button mat-fab color="primary" class="flip-button" 
                        (click)="toggleCardFlip(group.apartmentId)"
                        matTooltip="Torna al riassunto">
                  <mat-icon>arrow_back</mat-icon>
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
          
        </div>
      </div>
    </div>
  </div>

</div>