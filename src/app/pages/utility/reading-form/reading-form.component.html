<div class="reading-form-container">
  
  <!-- ZONA 1: Header fisso in alto -->
  <div class="form-header">
    <div class="header-content">
      <div class="header-title">
        <mat-icon [style.color]="getSelectedUtilityConfig()?.color || '#377d37'">
          {{getSelectedUtilityConfig()?.icon || 'add_circle_outline'}}
        </mat-icon>
        <div class="title-text">
          <h2>{{!!data.editingReading ? 'Modifica' : 'Nuova'}} Lettura</h2>
          <p *ngIf="getSelectedUtilityConfig()">
            {{getSelectedUtilityConfig()?.label}} &middot; {{getSelectedApartmentName()}}
          </p>
        </div>
      </div>
      
      <div class="utility-chips" *ngIf="readingForm && readingForm.get('type')?.value">
        <mat-chip [style.background-color]="getSelectedUtilityConfig()?.color + '15'" 
                  [style.color]="getSelectedUtilityConfig()?.color">
          <mat-icon>{{getSelectedUtilityConfig()?.icon}}</mat-icon>
          {{getSelectedUtilityConfig()?.label}}
          ({{getSelectedUtilityConfig()?.unit}})
        </mat-chip>
      </div>
    </div>
  </div>

  <!-- ZONA 2: Corpo scrollabile -->
  <div class="form-body">

    <!-- Banner ultima lettura -->
    <mat-card class="last-reading-card" *ngIf="lastReading">
      <div class="last-reading-content">
        <div class="reading-info">
          <div class="info-icon" [style.background]="getSelectedUtilityConfig()?.color + '15'">
            <mat-icon [style.color]="getSelectedUtilityConfig()?.color">history</mat-icon>
          </div>
          <div class="info-details">
            <div class="info-title">
              {{isFirstReading() ? 'Prima lettura' : 'Ultima lettura'}}
            </div>
            <div class="info-value" *ngIf="!isFirstReading()">
              {{lastReading.lastReading | number:'1.0-3'}} {{getSelectedUtilityConfig()?.unit}}
            </div>
            <div class="info-date" *ngIf="!isFirstReading()">
              {{lastReading.lastReadingDate | date:'dd/MM/yyyy'}}
            </div>
            <div class="info-message" *ngIf="isFirstReading()">
              Prima lettura per questo tipo di utenza. Inserisci la lettura precedente del contatore e quella attuale per calcolare il consumo.
            </div>
            <div class="info-message" *ngIf="shouldShowPreviousReadingField() && !isFirstReading()">
              Inserisci la lettura precedente e quella attuale per calcolare il consumo.
            </div>
          </div>
        </div>
        
        <div class="calculation-preview" *ngIf="canCalculateConsumption()">
          <div class="calculation-row">
            <span class="calc-label">Consumo:</span>
            <span class="calc-value">{{calculatedConsumption | number:'1.0-3'}} {{getSelectedUtilityConfig()?.unit}}</span>
          </div>
          <div class="calculation-row">
            <span class="calc-label">Costo:</span>
            <span class="calc-value total">€{{calculatedCost | number:'1.2-2'}}</span>
          </div>
        </div>
      </div>
      
      <div class="loading-overlay" *ngIf="isLoadingLastReading">
        <mat-spinner diameter="24"></mat-spinner>
        <span>Caricamento ultima lettura...</span>
      </div>
    </mat-card>

    <!-- Form fields -->
    <form *ngIf="readingForm" [formGroup]="readingForm" class="reading-form">
      
      <!-- Sezione: Informazioni Generali -->
      <mat-card class="form-section">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>info_outline</mat-icon>
            Informazioni Generali
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-grid">
            
            <mat-form-field appearance="outline">
              <mat-label>Appartamento</mat-label>
              <mat-icon matPrefix>home</mat-icon>
              <mat-select formControlName="apartmentId" [disabled]="!!data.editingReading">
                <mat-option *ngFor="let apartment of data.apartments" [value]="apartment.id">
                  {{apartment.name}}
                </mat-option>
              </mat-select>
              <mat-error>{{getFormControlError('apartmentId')}}</mat-error>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Tipo Utenza</mat-label>
              <mat-icon matPrefix>category</mat-icon>
              <mat-select formControlName="type" [disabled]="!!data.editingReading">
                <mat-select-trigger *ngIf="readingForm && readingForm.get('type')?.value">
                  <div class="selected-utility">
                    <mat-icon [style.color]="getSelectedUtilityConfig()?.color">
                      {{getSelectedUtilityConfig()?.icon}}
                    </mat-icon>
                    <span>{{getSelectedUtilityConfig()?.label}} ({{getSelectedUtilityConfig()?.unit}})</span>
                  </div>
                </mat-select-trigger>
                <mat-option *ngFor="let utility of utilityTypes" [value]="utility.type">
                  <div class="utility-option">
                    <mat-icon [style.color]="utility.color">{{utility.icon}}</mat-icon>
                    <span>{{utility.label}} ({{utility.unit}})</span>
                  </div>
                </mat-option>
              </mat-select>
              <mat-error>{{getFormControlError('type')}}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width" *ngIf="shouldShowSubtypeField()">
              <mat-label>Tipo Contatore</mat-label>
              <mat-icon matPrefix>electrical_services</mat-icon>
              <mat-select formControlName="subtype" [disabled]="!!data.editingReading">
                <mat-select-trigger *ngIf="readingForm && readingForm.get('subtype')?.value">
                  <div class="selected-utility">
                    <mat-icon [style.color]="readingForm.get('subtype')?.value === 'laundry' ? '#FFA726' : '#FF6B6B'">
                      {{readingForm.get('subtype')?.value === 'laundry' ? 'local_laundry_service' : 'bolt'}}
                    </mat-icon>
                    <span>{{readingForm.get('subtype')?.value === 'laundry' ? 'Elettricità Lavanderia' : 'Elettricità Principale'}}</span>
                  </div>
                </mat-select-trigger>
                <mat-option value="main">
                  <div class="utility-option">
                    <mat-icon style="color: #FF6B6B">bolt</mat-icon>
                    <span>Elettricità Principale</span>
                  </div>
                </mat-option>
                <mat-option value="laundry">
                  <div class="utility-option">
                    <mat-icon style="color: #FFA726">local_laundry_service</mat-icon>
                    <span>Elettricità Lavanderia</span>
                  </div>
                </mat-option>
              </mat-select>
              <mat-hint><strong>{{getSelectedApartmentName()}}</strong> ha due contatori elettrici separati</mat-hint>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Data Lettura</mat-label>
              <mat-icon matPrefix>calendar_today</mat-icon>
              <input matInput [matDatepicker]="picker" formControlName="readingDate">
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error>{{getFormControlError('readingDate')}}</mat-error>
            </mat-form-field>

          </div>
        </mat-card-content>
      </mat-card>

      <!-- Sezione: Valori Lettura -->
      <mat-card class="form-section">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>speed</mat-icon>
            Valori Lettura
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-grid">
            
            <mat-form-field appearance="outline" *ngIf="shouldShowPreviousReadingField()">
              <mat-label>
                Lettura Precedente 
                <span *ngIf="getSelectedUtilityConfig()">({{getSelectedUtilityConfig()?.unit}})</span>
              </mat-label>
              <mat-icon matPrefix [style.color]="getSelectedUtilityConfig()?.color">
                history
              </mat-icon>
              <input matInput type="number" formControlName="previousReading" 
                     placeholder="Lettura del mese precedente" 
                     min="0" step="0.01">
              <mat-error>{{getFormControlError('previousReading')}}</mat-error>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>
                Lettura Attuale 
                <span *ngIf="getSelectedUtilityConfig()">({{getSelectedUtilityConfig()?.unit}})</span>
              </mat-label>
              <mat-icon matPrefix [style.color]="getSelectedUtilityConfig()?.color">
                {{getSelectedUtilityConfig()?.icon || 'straighten'}}
              </mat-icon>
              <input matInput type="number" formControlName="currentReading" 
                     placeholder="Inserisci la lettura del contatore" 
                     min="0" step="0.01">
              <mat-error>{{getFormControlError('currentReading')}}</mat-error>
              <mat-hint *ngIf="lastReading && !isFirstReading()">
                Ultima lettura: {{lastReading.lastReading | number:'1.0-3'}} {{getSelectedUtilityConfig()?.unit}}
              </mat-hint>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Costo Unitario (€)</mat-label>
              <mat-icon matPrefix>euro</mat-icon>
              <input matInput type="number" formControlName="unitCost" 
                     placeholder="Costo per unità" 
                     min="0" step="0.01">
              <span matSuffix>/{{getSelectedUtilityConfig()?.unit || 'unità'}}</span>
              <mat-error>{{getFormControlError('unitCost')}}</mat-error>
            </mat-form-field>

          </div>
          
          <div class="consumption-display" *ngIf="canCalculateConsumption()">
            <div class="consumption-card">
              <div class="consumption-header">
                <mat-icon [style.color]="getSelectedUtilityConfig()?.color">trending_up</mat-icon>
                <span>Consumo Calcolato</span>
              </div>
              <div class="consumption-values">
                <div class="value-row">
                  <span class="label">Consumo:</span>
                  <span class="value">{{calculatedConsumption | number:'1.0-2'}} {{getSelectedUtilityConfig()?.unit}}</span>
                </div>
                <div class="value-row total">
                  <span class="label">Costo Totale:</span>
                  <span class="value">€{{calculatedCost | number:'1.2-2'}}</span>
                </div>
              </div>
            </div>
          </div>

        </mat-card-content>
      </mat-card>

      <!-- Messaggio errore -->
      <div class="error-message" *ngIf="errorMessage">
        <mat-icon>error_outline</mat-icon>
        <span>{{errorMessage}}</span>
      </div>

    </form>
  </div>

  <!-- ZONA 3: Footer azioni fisso in basso -->
  <div class="form-actions">
    <button mat-button type="button" (click)="onCancel()" [disabled]="isLoading">
      Annulla
    </button>
    
    <button mat-flat-button color="primary" type="button"
            (click)="onSubmit()"
            [disabled]="isLoading || (readingForm && readingForm.invalid)">
      <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
      <mat-icon *ngIf="!isLoading">{{!!data.editingReading ? 'save' : 'check'}}</mat-icon>
      {{!!data.editingReading ? 'Aggiorna' : 'Salva'}} Lettura
    </button>
  </div>

</div>
